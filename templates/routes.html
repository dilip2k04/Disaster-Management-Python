{% extends "base.html" %}

{% block title %}Emergency Services Locator - Safety Bridge{% endblock %}

{% block content %}

<style>
  :root {
    --primary: #2563eb;
    --primary-dark: #1d4ed8;
    --secondary: #ef4444;
    --secondary-dark: #dc2626;
    --hospital: #10b981;
    --police: #3b82f6;
    --fire: #ef4444;
    --success: #10b981;
    --warning: #f59e0b;
    --gray-50: #f8fafc;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-700: #334155;
    --gray-800: #1e293b;
    --gray-900: #0f172a;
    --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
    --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
    --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
    --radius: 14px;
    --radius-lg: 18px;
    --transition: all 0.3s ease;
  }

  .main-container {
    flex: 1;
    display: flex;
    height: calc(100vh - var(--header-height, 70px));
    overflow: hidden;
  }

  #map {
    flex: 2;
    height: 100%;
  }

  #sidebar {
    flex: 1;
    max-width: 420px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(12px);
    border-left: 1px solid rgba(0,0,0,0.08);
    display: flex;
    flex-direction: column;
    overflow: hidden;
    box-shadow: -6px 0 20px rgba(0,0,0,0.1);
  }

  .sidebar-header {
    padding: 1.6rem 1.8rem;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: rgba(37, 99, 235, 0.05);
  }

  .sidebar-header h2 {
    font-weight: 700;
    font-size: 1.45rem;
    margin: 0 0 1.2rem;
    color: var(--gray-900);
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .service-filters {
    display: flex;
    flex-wrap: wrap;
    gap: 0.8rem;
  }

  .filter-btn {
    padding: 0.55rem 1.1rem;
    border-radius: 50px;
    background: white;
    border: 1px solid var(--gray-300);
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--gray-700);
    cursor: pointer;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .filter-btn:hover {
    background: var(--gray-100);
    transform: translateY(-1px);
  }

  .filter-btn.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    box-shadow: 0 4px 12px rgba(37,99,235,0.25);
  }

  .services-list {
    flex: 1;
    overflow-y: auto;
    padding: 1.5rem;
  }

  .empty-state, .loader {
    text-align: center;
    padding: 4rem 1.5rem;
    color: var(--gray-500);
  }

  .empty-state i, .loader i {
    font-size: 3.5rem;
    margin-bottom: 1.2rem;
    color: var(--gray-300);
  }

  /* Service Card */
  .service-card {
    background: white;
    border-radius: var(--radius);
    padding: 1.3rem;
    margin-bottom: 1.2rem;
    box-shadow: var(--shadow-sm);
    border-left: 5px solid transparent;
    transition: all 0.28s ease;
    cursor: pointer;
  }

  .service-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-lg);
  }

  .service-card.hospital { border-left-color: var(--hospital); }
  .service-card.police   { border-left-color: var(--police); }
  .service-card.fire     { border-left-color: var(--fire); }

  .service-type {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    font-size: 0.82rem;
    font-weight: 600;
    padding: 0.35rem 0.9rem;
    border-radius: 50px;
    margin-bottom: 0.6rem;
  }

  .type-hospital { background: rgba(16,185,129,0.12); color: var(--hospital); }
  .type-police   { background: rgba(59,130,246,0.12);  color: var(--police); }
  .type-fire     { background: rgba(239,68,68,0.12);   color: var(--fire); }

  .service-name {
    font-weight: 700;
    font-size: 1.18rem;
    margin-bottom: 0.5rem;
    color: var(--gray-900);
  }

  .service-distance {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    color: var(--gray-600);
    margin-bottom: 1rem;
  }

  .service-actions {
    display: flex;
    gap: 0.8rem;
  }

  .btn {
    padding: 0.65rem 1.2rem;
    border-radius: 10px;
    font-weight: 600;
    font-size: 0.92rem;
    cursor: pointer;
    transition: all 0.25s;
    flex: 1;
    text-align: center;
    border: none;
  }

  .btn-primary {
    background: var(--primary);
    color: white;
  }

  .btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
  }

  .btn-secondary {
    background: var(--gray-100);
    color: var(--gray-800);
    border: 1px solid var(--gray-300);
  }

  .btn-secondary:hover {
    background: var(--gray-200);
    transform: translateY(-1px);
  }

  .emergency-call {
    display: inline-flex;
    align-items: center;
    gap: 10px;
    background: var(--secondary);
    color: white;
    padding: 0.8rem 1.5rem;
    border-radius: 50px;
    font-weight: 700;
    text-decoration: none;
    margin: 1rem 0;
    transition: all 0.3s;
  }

  .emergency-call:hover {
    background: var(--secondary-dark);
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(220,38,38,0.3);
  }

  @media (max-width: 992px) {
    .main-container {
      flex-direction: column;
    }
    #sidebar {
      max-width: 100%;
      max-height: 45vh;
      border-left: none;
      border-top: 1px solid var(--gray-200);
      box-shadow: 0 -4px 12px rgba(0,0,0,0.08);
    }
  }

  @media (max-width: 576px) {
    .service-filters {
      justify-content: center;
    }
    .service-actions {
      flex-direction: column;
      gap: 0.6rem;
    }
  }
</style>

<div class="main-container">
  <div id="map"></div>

  <div id="sidebar">
    <div class="sidebar-header">
      <h2><i class="fas fa-map-marker-alt"></i> Nearby Emergency Services</h2>

      <div class="service-filters">
        <button class="filter-btn active" data-type="all">
          <i class="fas fa-list"></i> All
        </button>
        <button class="filter-btn" data-type="hospital">
          <i class="fas fa-hospital"></i> Hospitals
        </button>
        <button class="filter-btn" data-type="police">
          <i class="fas fa-shield-alt"></i> Police
        </button>
        <button class="filter-btn" data-type="fire">
          <i class="fas fa-fire-extinguisher"></i> Fire
        </button>
      </div>
    </div>

    <div class="loader" id="loader">
      <div class="spinner"></div>
      <p>Finding services near you...</p>
    </div>

    <div class="services-list" id="services-list">
      <div class="empty-state">
        <i class="fas fa-map-marker-alt"></i>
        <h3>Waiting for location</h3>
        <p>Allow location access to see nearby hospitals, police stations, and fire departments.</p>
      </div>
    </div>

    <div style="padding:1.2rem; border-top:1px solid var(--gray-200); text-align:center;">
      <a href="tel:112" class="emergency-call">
        <i class="fas fa-phone-volume"></i> EMERGENCY: 112
      </a>
    </div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONFIG
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const serviceConfig = {
  hospital: { tag: 'amenity=hospital',        color: '#10b981', icon: 'hospital',       name: 'Hospital' },
  police:   { tag: 'amenity=police',          color: '#3b82f6',  icon: 'shield-alt',     name: 'Police Station' },
  fire:     { tag: 'amenity=fire_station',    color: '#ef4444',  icon: 'fire-extinguisher', name: 'Fire Station' }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MAP SETUP
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const map = L.map('map', {
  zoomControl: true,
  zoomSnap: 0.5
}).setView([20.5937, 78.9629], 5);

L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
}).addTo(map);

// User location marker (will be set later)
let userMarker = null;
let userLat, userLon;
let allMarkers = [];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DOM ELEMENTS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const servicesList = document.getElementById('services-list');
const loader = document.getElementById('loader');

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  DISTANCE CALCULATION
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371; // km
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  const distance = R * c;

  return distance < 1 ? Math.round(distance * 1000) + ' m' : distance.toFixed(1) + ' km';
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CREATE MARKER & CARD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addService(lat, lon, name, type) {
  const cfg = serviceConfig[type];
  const distance = getDistance(userLat, userLon, lat, lon);

  // Marker
  const marker = L.marker([lat, lon], {
    icon: L.divIcon({
      html: `<div style="
        background:${cfg.color};
        width:32px;height:32px;
        border-radius:50%;
        border:3px solid white;
        box-shadow:0 0 12px ${cfg.color}80;
        display:flex;align-items:center;justify-content:center;
        color:white;font-size:16px;
      ">${cfg.icon === 'hospital' ? 'ğŸ¥' : cfg.icon === 'shield-alt' ? 'ğŸ‘®' : 'ğŸš’'}</div>`,
      iconSize: [32, 32],
      iconAnchor: [16, 16],
      popupAnchor: [0, -16],
      className: ''
    })
  }).addTo(map);

  marker.bindPopup(`
    <b>${name}</b><br>
    ${cfg.name}<br>
    <small>${distance} away</small>
  `);

  allMarkers.push({marker, type});

  // Card
  const card = document.createElement('div');
  card.className = `service-card ${type}`;
  card.innerHTML = `
    <div class="service-type type-${type}">
      <i class="fas fa-${cfg.icon}"></i> ${cfg.name}
    </div>
    <div class="service-name">${name}</div>
    <div class="service-distance">
      <i class="fas fa-map-marker-alt"></i> ${distance} away
    </div>
    <div class="service-actions">
      <button class="btn btn-secondary" onclick="map.flyTo([${lat},${lon}], 16)">View on Map</button>
      <a href="https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}" target="_blank" class="btn btn-primary">
        Navigate
      </a>
    </div>
  `;

  card.addEventListener('click', (e) => {
    if (!e.target.closest('a, button')) {
      map.flyTo([lat, lon], 16);
      marker.openPopup();
    }
  });

  servicesList.appendChild(card);
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FILTER MARKERS & CARDS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function filterServices(type) {
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.type === type);
  });

  document.querySelectorAll('.service-card').forEach(card => {
    card.style.display = (type === 'all' || card.classList.contains(type)) ? 'block' : 'none';
  });

  allMarkers.forEach(m => {
    if (type === 'all' || m.type === type) {
      map.addLayer(m.marker);
    } else {
      map.removeLayer(m.marker);
    }
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  LOCATION HANDLING
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showLoader() {
  loader.style.display = 'block';
  servicesList.innerHTML = '';
}

function hideLoader() {
  loader.style.display = 'none';
  if (servicesList.children.length === 0) {
    servicesList.innerHTML = `
      <div class="empty-state">
        <i class="fas fa-exclamation-triangle"></i>
        <h3>No services found nearby</h3>
        <p>Try zooming out or enabling location services.</p>
      </div>`;
  }
}

if (navigator.geolocation) {
  showLoader();

  navigator.geolocation.getCurrentPosition(
    async (pos) => {
      userLat = pos.coords.latitude;
      userLon = pos.coords.longitude;

      map.setView([userLat, userLon], 13);

      // User marker
      userMarker = L.marker([userLat, userLon], {
        icon: L.divIcon({
          html: `<div style="
            background:#2563eb;
            width:40px;height:40px;
            border-radius:50%;
            border:4px solid white;
            box-shadow:0 0 15px #2563eb80;
            display:flex;align-items:center;justify-content:center;
            color:white;font-size:18px;
          "><i class="fas fa-user"></i></div>`,
          iconSize: [40, 40],
          iconAnchor: [20, 20],
          className: ''
        })
      }).addTo(map).bindPopup("You are here").openPopup();

      // Radius circle
      L.circle([userLat, userLon], {
        radius: 5000,
        color: '#2563eb',
        fillColor: '#3b82f6',
        fillOpacity: 0.12
      }).addTo(map);

      // Fetch services
      for (const [type, cfg] of Object.entries(serviceConfig)) {
        try {
          const overpassUrl = `https://overpass-api.de/api/interpreter?data=[out:json];node[${cfg.tag}](around:5000,${userLat},${userLon});out;`;
          const res = await fetch(overpassUrl);
          const data = await res.json();

          data.elements.forEach((el, idx) => {
            const name = el.tags.name || `${cfg.name} ${idx + 1}`;
            addService(el.lat, el.lon, name, type);
          });
        } catch (err) {
          console.error(`Error fetching ${type}:`, err);
        }
      }

      hideLoader();
      filterServices('all');
    },
    (err) => {
      console.error("Geolocation error:", err);
      servicesList.innerHTML = `
        <div class="empty-state">
          <i class="fas fa-exclamation-triangle"></i>
          <h3>Location access denied</h3>
          <p>Please allow location access to find nearby emergency services.</p>
          <button onclick="location.reload()" style="
            margin-top:1.5rem;
            padding:0.8rem 1.6rem;
            background:var(--primary);
            color:white;
            border:none;
            border-radius:10px;
            font-weight:600;
            cursor:pointer;
          ">Retry</button>
        </div>`;
      hideLoader();
    },
    { enableHighAccuracy: true, timeout: 8000, maximumAge: 0 }
  );
} else {
  servicesList.innerHTML = `
    <div class="empty-state">
      <i class="fas fa-exclamation-triangle"></i>
      <h3>Geolocation not supported</h3>
      <p>Your browser does not support location services.</p>
    </div>`;
}

// Filter buttons
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => filterServices(btn.dataset.type));
});
</script>

{% endblock %}